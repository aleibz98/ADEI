---
title: "Primera Práctica de ADEI"
author: "Alejandro Alarcón"
date: "10/19/2021"
output:
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: 4
  html_document:
    toc: no
    toc_depth: '4'
  word_document:
    toc: no
    toc_depth: '4'
geometry: left=1.9cm,right=1.9cm,top=1.25cm,bottom=1.52cm
fontsize: 18pt
subtitle: 'Laboratori 1 - Data Preparation'
classoption: a4paper
editor_options: 
  chunk_output_type: console
---

Configuración del environment
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require("knitr")
opts_knit$set(root.dir = "/Users/aleibz/ADEI/ADEI/ADEI/CarPrices/")
```

Limpiamos el environment.
```{r}
# Clear plots
if(!is.null(dev.list())) dev.off()

# Clean workspace
rm(list=ls())
```

Importamos las librerias y paquetes necesarios.

```{r}
options(contrasts=c("contr.treatment","contr.treatment"))

requiredPackages <- c("effects","FactoMineR","car", "factoextra","RColorBrewer","ggplot2","dplyr","ggmap","ggthemes","knitr", "missMDA")

package.check <- lapply(requiredPackages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE)
    library(x, character.only = TRUE)
  }
})
#verify they are loaded
search()
```

Cargamos los datos
```{r}
filepath<-"/Users/aleibz/ADEI/ADEI/ADEI/CarPrices/"
load(paste0(filepath,"MyOldCars-Raw.RData"))
```

Echamos un vistazo al dataset
```{r}
summary( df )
names( df )
```

## Transformación de variables categóricas a factores
```{r}
#Model
df$model <- factor(paste0(df$manufacturer, "-", df$model))
levels(df$model)

#Transmission
df$transmission <- factor( df$transmission )
levels( df$transmission )
df$transmission <- factor( df$transmission, levels = c("Manual","Semi-Auto","Automatic"),labels = paste0("f.Trans-",c("Manual","SemiAuto","Automatic")))
head( df )

#FuelType
df$fuelType <- factor(df$fuelType)
levels(df$fuelType)
df$fuelType <- factor( df$fuelType, levels = c("Diesel","Petrol","Hybrid"), labels = paste0("f.Fuel-",c("Diesel","Petrol","Hybrid")))

#Manufacturer
df$manufacturer <- factor(df$manufacturer)
```

## Transformación de variables numéricas a factores
```{r}
#Year + Age
summary(df$year)
df$age <-  2021 - df$year 
df$year<-factor(df$year)
summary(df$age)

#EngineSize
summary(df$engineSize)
df$engineSize_factor <- factor(df$engineSize)
summary(df$engineSize_factor)
```

## Explorar variables con summary y plots
```{r}
# Factores
summary( df$year )
plot( df$year )

summary( df$engineSize_factor )
plot( df$engineSize_factor )

summary( df$fuelType )
plot( df$fuelType )

summary( df$transmission )
plot( df$transmission )

summary(df$fuelType )
plot( df$fuelType )


# Numéricas
summary( df$age )
boxplot( df$age )

summary( df$price )
boxplot( df$price )

summary( df$mileage )
boxplot( df$mileage )

summary( df$tax )
boxplot( df$tax )

summary( df$mpg )
boxplot( df$mpg )
```

Funciones útiles
```{r}
calcQ <- function(x) {
  s.x <- summary(x)
  iqr<-s.x[5]-s.x[2]
  list(souti=s.x[2]-3*iqr, mouti=s.x[2]-1.5*iqr, min=s.x[1], q1=s.x[2], q2=s.x[3], 
       q3=s.x[5], max=s.x[6], mouts=s.x[5]+1.5*iqr, souts=s.x[5]+3*iqr ) }

countNA <- function(x) {
  mis_x <- NULL
  for (j in 1:ncol(x)) {mis_x[j] <- sum(is.na(x[,j])) }
  mis_x <- as.data.frame(mis_x)
  rownames(mis_x) <- names(x)
  mis_i <- rep(0,nrow(x))
  for (j in 1:ncol(x)) {mis_i <- mis_i + as.numeric(is.na(x[,j])) }
  list(mis_col=mis_x,mis_ind=mis_i) }

countX <- function(x,X) {
  n_x <- NULL
  for (j in 1:ncol(x)) {n_x[j] <- sum(x[,j]==X) }
  n_x <- as.data.frame(n_x)
  rownames(n_x) <- names(x)
  nx_i <- rep(0,nrow(x))
  for (j in 1:ncol(x)) {nx_i <- nx_i + as.numeric(x[,j]==X) }
  list(nx_col=n_x,nx_ind=nx_i) }
```

# Por cada variable
## Conteo de missings
```{r}
imis<-rep(0,nrow(df))  # rows - trips
jmis<-rep(0,2*ncol(df))  # columns - variables

mis1<-countNA(df)
imis<-mis1$mis_ind
inds <- which(imis > 0)
df[inds,]
mis1$mis_col # Number of missings for the current set of variables

```
Como se puede apreciar en la salida, solo aparecen un total de 13 missing values en todo el dataframe.
Si miramos por variables, estos 13 missings aparecen en la columna de engineSize.
Por otro lado, y si miramos por individuos, podemos ver como para los 13 individuos que tienen missings, este está en la columna de engineSize.

## Conteo de outliers
```{r}
iouts<-rep(0,nrow(df))  # rows - trips
jouts<-rep(0,2*ncol(df))  # columns - variables

# Funcion que recibe como parametro una columna y devuelve los ids de los individuos outlier
outliers_column <- function(x){
  out_bounds <- calcQ(x)
  ex <- which((x<out_bounds$souti)|(x>out_bounds$souts))
  mild <- which(((x>out_bounds$souti)&(x<out_bounds$mouti))|((x<out_bounds$souts)&(x>out_bounds$mouts)))
  list(extreme=ex, mild=mild)
}

# Estos son los outliers tanto mild como extreme de las variables numéricas
outs_price <- outliers_column(df$price)
outs_mileage <- outliers_column(df$mileage)
outs_tax <- outliers_column(df$tax)
outs_mpg <- outliers_column(df$mpg)
outs_age <- outliers_column(df$age)

# Conteo de extreme outliers
sum_extreme_outliers <- length(outs_price$extreme) + length(outs_mileage$extreme) + length(outs_tax$extreme) + length(outs_mpg$extreme) + length(outs_age$extreme)

# Conteo de mild outliers
sum_mild_outliers <- length(outs_price$mild) + length(outs_mileage$mild) + length(outs_tax$mild) + length(outs_mpg$mild) + length(outs_age$mild)

# Es curioso que sum_extreme > sum_mild
```

Ponemos los extreme outliers como missings
```{r}
df[outs_mileage$extreme,"mileage"]<-NA
df[outs_tax$extreme,"tax"]<-NA
df[outs_mpg$extreme,"mpg"]<-NA
df[outs_age$extreme,"age"]<-NA
```

## Conteo de errores
```{r}
# Price
  err_price <- which(df$price<0)

# Age
  err_age <- which(df$age<0)
  
# Mileage
  err_mileage <- which(df$mileage<0)
  
# mpg
  err_mpg <- which(df$mpg<0)
  
# engineSize
  err_engineSize_fac <- which(df$engineSize_factor == "0")
  df[err_engineSize_fac,"engineSize_factor"] <- NA
  
# tax
  err_tax <- which(df$tax<0)
```

#Por cada individuo
## Conteo de missings (función que reciba el individuo como parámetro)
```{r}
#DONE
```

## Conteo de errores (función que reciba el individuo como parámetro)
```{r}

```

## Conteo de outliers (función que reciba el individuo como parámetro)
```{r}

```

# Imputación
```{r}
library(missMDA)

names(df)
vars_num <- names(df)[c(3,5,7,8,11)]
vars_cat <- names(df)[c(1,2,4,6,10,12)]
vars_res <- names(df)[c(3)]
```

## Variables numéricas
```{r}
summary(df[,vars_num])

res.impca <- imputePCA(df[,vars_num], ncp = 2)
summary(res.impca$completeObs)

res.impca$completeObs[ outs_age$extreme, "age" ]
res.impca$completeObs[ outs_mileage$extreme, "mileage" ]
res.impca$completeObs[ outs_tax$extreme, "tax" ]
res.impca$completeObs[ outs_mpg$extreme, "mpg" ]

df[, vars_num] <- res.impca$completeObs

summary(df$age)
df[outs_age$extreme,"age"]
df[outs_mpg$extreme,"mpg"]
```

## Factores
```{r}
summary(df[,vars_cat])
res.immca <- imputeMCA(df[,vars_cat],ncp=10)
summary(res.immca$completeObs)

df[,vars_cat]<-res.immca$completeObs
```

# Discretización de variables numéricas en factores (por cuantiles)
```{r}
vars_num
```

### Mileage
```{r}
summary(df$mileage)
boxplot(df$mileage)

quants <- quantile(df$mileage,seq(0,1,0.25),na.rm=TRUE)

df$aux <- factor(cut(df$mileage, breaks=quants[1:5], include.lowest = TRUE))
table(df$aux)
tapply(df$mileage, df$aux, median)
df$f.miles<-factor(cut(df$mileage/1000,breaks=quants[1:5]/1000,include.lowest = TRUE ))
levels(df$f.miles)<-paste("f.miles-",levels(df$f.miles),sep="")
table(df$f.miles)
#Esto cuadra ya que estamos tomando como referencia los quantiles y podemos ver como en todos hay el mismo número de elementos
```

### Tax
```{r}
summary(df$tax)
boxplot(df$tax)
hist(df$tax, breaks=100)

quants <- quantile(df$tax,seq(0,1,0.1),na.rm=TRUE)

df$aux <- factor(cut(df$tax, breaks=quants[1:11], include.lowest = TRUE))
table(df$aux)
tapply(df$tax, df$aux, median)
df$f.tax<-factor(cut(df$tax,breaks=quants[1:5],include.lowest = TRUE ))
levels(df$f.tax)<-paste("f.tax-",levels(df$f.tax),sep="")
table(df$f.tax)
```

### Mpg
```{r}
summary(df$mpg)
boxplot(df$mpg)
hist(df$mpg)

quants <- quantile(df$mpg,seq(0,1,0.25),na.rm=TRUE)

df$aux <- factor(cut(df$mpg, breaks=quants[1:5], include.lowest = TRUE))
table(df$aux)
tapply(df$mpg, df$aux, median)
df$f.mpg<-factor(cut(df$mpg,breaks=quants[1:5],include.lowest = TRUE ))
levels(df$f.mpg)<-paste("f.mpg-",levels(df$f.mpg),sep="")
table(df$f.mpg)
```

### Age
```{r}
summary(df$age)
boxplot(df$age)
hist(df$age)

quants <- quantile(df$age,seq(0,1,0.25),na.rm=TRUE)

df$aux <- factor(cut(df$age, breaks=quants[1:5], include.lowest = TRUE))
table(df$aux)
tapply(df$age, df$aux, median)
df$f.age<-factor(cut(df$age,breaks=quants[1:5],include.lowest = TRUE ))
levels(df$f.age)<-paste("f.age-",levels(df$f.age),sep="")
table(df$f.age)
```

## Identificar los outliers multivariantes
```{r}
library(mvoutlier)

ll<-which(is.na(df$price)) #vacío
summary(df[,vars_num])

mout<-aq.plot(df[,c(3,5,7,8,9,11)],delta=qchisq(0.995,5),quan=0.995)
```

```{r}
library(chemometrics)
mout<-Moutlier(df[,c(3,5,8)],quantile = 0.995, plot = TRUE)
ll<-which(mout$rd>5)
Boxplot(mout$rd)
df[ll,c(vars_res,vars_num)]
df$mout <- 0
df$mout[ ll ]<-1
df$mout <- factor( df$mout, labels=c( "NoMOut","YesMOut"))
table(df$mout)
```

# Relaciones entre variables
## Correlaciones
```{r}
# No se que quiere decir exactamente... Pensaba que esto venía por el profiling...
```

## Texto que no sé que quiere decir
```{r}

```

# Profiling

## Target numérico (Price)
```{r}
library(FactoMineR)
summary(df$price)
res.condes<-condes(df[,c(vars_res,vars_num,vars_cat)],1)

res.condes$quanti  # Global association to numeric variables
res.condes$quali # Global association to factors
res.condes$category  # Partial association to significative levels in factors
```

```{r}
# The "variable to describe cannot have NA ###################################
res.catdes<-catdes(df[,c("manufacturer",vars_num,vars_cat)],1)

res.catdes$quanti.var  # Global association to numeric variables
res.catdes$quanti # Partial association of numeric variables to levels of outcome factor
res.catdes$test.chi2 # Global association to factors
res.catdes$category  # Partial association to significative levels in factors
```

## Target factor (AUDI)
```{r}

```



